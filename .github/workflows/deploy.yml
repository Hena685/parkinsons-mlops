name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'model.pkl'
      - 'README.md'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Parkinson's Detection Space
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install huggingface_hub
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub[cli]

    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Push to Hugging Face Space
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
      run: |
        SPACE_NAME="${HF_USERNAME}/parkinsons-detection"

        # Login to Hugging Face
        python -c "from huggingface_hub import login; import os; login(token=os.environ['HF_TOKEN'], add_to_git_credential=True); print('✅ Logged in to Hugging Face')"

        # Clone the space
        git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        cd hf-space

        # Copy only necessary files from root
        cp ../app.py .
        cp ../requirements.txt .
        cp ../model.pkl .
        cp ../README.md .

        # Commit and push if there are changes
        git add .
        if git diff --staged --quiet; then
          echo "ℹ️ No changes to deploy"
        else
          git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S') - SHA: ${{ github.sha }}"
          git push https://user:${HF_TOKEN}@huggingface.co/spaces/$SPACE_NAME main
          echo "✅ Deployment successful!"
