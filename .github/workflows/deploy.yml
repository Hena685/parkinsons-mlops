name: Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
    paths:
      - 'app.py'
      - 'requirements.txt'
      - 'model.pkl'
      - 'README.md'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Parkinson's Detection Space
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install huggingface_hub[cli]

    - name: Login to Hugging Face
      uses: huggingface-cli/login@v1
      with:
        token: ${{ secrets.HF_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"

    - name: Push to Hugging Face Space
      env:
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        SPACE_NAME="${HF_USERNAME}/parkinsons-detection"

        # Clone the space
        git clone https://huggingface.co/spaces/$SPACE_NAME hf-space
        cd hf-space

        # Copy files from root
        cp ../app.py .
        cp ../requirements.txt .
        cp ../model.pkl .
        cp ../README.md .

        # Commit and push if there are changes
        git add .
        if git diff --staged --quiet; then
          echo "ℹ️ No changes to deploy"
        else
          git commit -m "Deploy from GitHub Actions - $(date '+%Y-%m-%d %H:%M:%S') - SHA: ${{ github.sha }}"
          git push https://user:${HF_TOKEN}@huggingface.co/spaces/$SPACE_NAME main
          echo "✅ Deployment successful!"
        fi
